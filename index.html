<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Youmio Season 1 Invite</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: #fff;
    }

    .container {
      width: 100%;
      max-width: 420px;
    }

    .logo {
      text-align: center;
      margin-bottom: 24px;
    }

    .logo svg {
      height: 40px;
      margin-bottom: 8px;
    }

    .card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 28px;
      backdrop-filter: blur(10px);
    }

    .view { display: none; }
    .view.active { display: block; }

    .header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 24px;
    }

    .icon {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, #ec4899, #a855f7);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .title {
      font-size: 18px;
      font-weight: 600;
    }

    .subtitle {
      font-size: 13px;
      color: rgba(255,255,255,0.5);
      margin-top: 2px;
    }

    .invite-count {
      color: #4ade80;
      font-weight: 500;
    }

    .verify-section {
      text-align: center;
      padding: 20px 0;
    }

    .verify-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .verify-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .verify-text {
      font-size: 13px;
      color: rgba(255,255,255,0.6);
      line-height: 1.5;
      margin-bottom: 20px;
    }

    .inviter-box, .wallet-box {
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 20px;
    }

    .inviter-label {
      font-size: 11px;
      color: rgba(255,255,255,0.4);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .inviter-addr {
      font-size: 14px;
      font-family: monospace;
      color: #fff;
      word-break: break-all;
    }

    .btn {
      width: 100%;
      padding: 14px 20px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-wallet {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white;
    }

    .btn-wallet:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
    }

    .btn-primary {
      background: linear-gradient(135deg, #ec4899, #a855f7);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4);
    }

    .btn-secondary {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: rgba(255,255,255,0.15);
    }

    .mobile-note {
      font-size: 12px;
      color: rgba(255,255,255,0.4);
      text-align: center;
      margin-top: 16px;
      line-height: 1.5;
    }

    .error {
      color: #f87171;
      font-size: 13px;
      margin-top: 12px;
      display: none;
    }

    .error.show { display: block; }

    .info-box {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 20px;
    }

    .info-text {
      font-size: 13px;
      color: rgba(255,255,255,0.7);
      line-height: 1.5;
    }

    .codes-list {
      margin: 20px 0;
    }

    .code-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .code-link {
      flex: 1;
      font-size: 12px;
      font-family: monospace;
      color: #4ade80;
      word-break: break-all;
    }

    .code-copy {
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      color: white;
      cursor: pointer;
      font-size: 12px;
    }

    .code-copy:hover { background: rgba(255,255,255,0.2); }
    .code-copy.copied { background: #4ade80; color: #000; }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }

    .btn-row .btn { flex: 1; }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      font-size: 13px;
      color: rgba(255,255,255,0.6);
      margin-bottom: 8px;
    }

    .input-group input {
      width: 100%;
      padding: 14px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      color: white;
      font-size: 15px;
      font-family: monospace;
    }

    .input-group input:focus {
      outline: none;
      border-color: rgba(168, 85, 247, 0.5);
    }

    .input-group input::placeholder {
      color: rgba(255,255,255,0.3);
    }

    .success-icon {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #4ade80, #22c55e);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }

    .success-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .success-text {
      font-size: 14px;
      color: rgba(255,255,255,0.6);
      line-height: 1.6;
      margin-bottom: 24px;
    }

    .status-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .status-icon.warning { color: #fbbf24; }
    .status-icon.error { color: #f87171; }

    .loading-view {
      text-align: center;
      padding: 40px 20px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #a855f7;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: rgba(255,255,255,0.5);
      font-size: 14px;
    }

    .season-text {
      text-align: center;
      margin-top: 20px;
      font-size: 12px;
      color: rgba(255,255,255,0.3);
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    /* Wallet Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.hidden { display: none; }

    .modal {
      background: #1a1a2e;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 24px;
      width: 100%;
      max-width: 360px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      text-align: center;
    }

    .wallet-option {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .wallet-option:hover:not(.disabled) {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.2);
    }

    .wallet-option img {
      width: 36px;
      height: 36px;
      border-radius: 8px;
    }

    .wallet-option-name { font-weight: 600; font-size: 15px; }
    .wallet-option-desc { font-size: 12px; color: rgba(255,255,255,0.5); }

    .wallet-option.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .modal-close {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      color: rgba(255,255,255,0.6);
      font-size: 14px;
      cursor: pointer;
    }

    .modal-close:hover { background: rgba(255,255,255,0.05); }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <svg width="60" height="52" viewBox="0 0 60 52" fill="none">
        <path d="M30 0C16.2 0 5 10.8 5 24v28h10V24c0-8.4 6.6-15 15-15s15 6.6 15 15v28h10V24C55 10.8 43.8 0 30 0z" fill="url(#logo-gradient)"/>
        <defs>
          <linearGradient id="logo-gradient" x1="5" y1="0" x2="55" y2="52" gradientUnits="userSpaceOnUse">
            <stop offset="0%" stop-color="#c084fc"/>
            <stop offset="50%" stop-color="#ec4899"/>
            <stop offset="100%" stop-color="#f97316"/>
          </linearGradient>
        </defs>
      </svg>
    </div>

    <div class="card">
      <!-- Loading View -->
      <div id="view-loading" class="view active">
        <div class="loading-view">
          <div class="loading-spinner"></div>
          <p class="loading-text">Loading...</p>
        </div>
      </div>

      <!-- Verify Wallet View -->
      <div id="view-verify" class="view">
        <div class="header">
          <div class="icon">
            <svg width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="white"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/></svg>
          </div>
          <div>
            <div class="title">Invite a Friend to Season 1</div>
            <div class="subtitle">Verify wallet to continue</div>
          </div>
        </div>

        <div class="verify-section">
          <div class="verify-icon">üîê</div>
          <div class="verify-title">Verify You Own This Wallet</div>
          <div class="verify-text">To generate invite links, please connect your wallet and sign a message to prove ownership.</div>
          <div class="inviter-box" style="text-align: left;">
            <div class="inviter-label">Wallet to verify</div>
            <div class="inviter-addr" id="verify-wallet-display"></div>
          </div>
          <button class="btn btn-wallet" id="connect-wallet-btn">
            <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>
            Connect Wallet & Sign
          </button>
          <p class="mobile-note">üì± On mobile? Open this link in your wallet app's browser</p>
          <p id="verify-error" class="error" style="text-align: center;"></p>
        </div>
      </div>

      <!-- Share View (after verification) -->
      <div id="view-share" class="view">
        <div class="header">
          <div class="icon">
            <svg width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="white"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/></svg>
          </div>
          <div>
            <div class="title">Invite a Friend to Season 1</div>
            <div class="subtitle invite-count" id="invite-count">Loading...</div>
          </div>
        </div>

        <div class="info-box">
          <p class="info-text">Generate unique invite links for your friends. Each link can only be used once.</p>
        </div>

        <div id="no-invites-msg" style="display: none; text-align: center; padding: 20px 0;">
          <p style="color: rgba(255,255,255,0.6);">You've used all your invites.</p>
        </div>

        <div id="has-invites">
          <button class="btn btn-primary" id="generate-btn">‚ú® Generate Invite Link</button>
        </div>

        <div id="codes-container" class="codes-list"></div>

        <p id="generate-error" class="error" style="text-align: center;"></p>
      </div>

      <!-- Claim View (for invitees) -->
      <div id="view-claim" class="view">
        <div class="header">
          <div class="icon">üéÅ</div>
          <div>
            <div class="title">Youmio Season 1 Invite</div>
            <div class="subtitle">Claim your early access</div>
          </div>
        </div>

        <div class="inviter-box">
          <div class="inviter-label">Invited by</div>
          <div class="inviter-addr" id="inviter-display"></div>
        </div>

        <div class="input-group">
          <label>Enter your wallet address to claim access</label>
          <input type="text" id="wallet-input" placeholder="0x..." autocomplete="off" spellcheck="false">
        </div>

        <button class="btn btn-primary" id="submit-btn">Claim Your Access</button>

        <p class="info-text" style="margin-top: 16px; text-align: center;">Once allowlisted, you'll be able to earn Affinity which will unlock Youmio Ecosystem Rewards.</p>

        <p id="claim-error" class="error" style="text-align: center;"></p>
      </div>

      <!-- Success View -->
      <div id="view-success" class="view" style="text-align: center;">
        <div class="success-icon">
          <svg width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
        </div>
        <div class="success-title">Access Claimed!</div>
        <p class="success-text">Your wallet will be added to the Season 1 allowlist. This might take a few hours to activate.</p>
        <div class="wallet-box">
          <div class="inviter-label">Your wallet</div>
          <div class="inviter-addr" id="success-wallet" style="font-size: 13px; word-break: break-all;"></div>
        </div>
        <a href="https://app.youmio.ai/" class="btn btn-primary" style="text-decoration: none;">Return to Youmio App</a>
      </div>

      <!-- Used View -->
      <div id="view-used" class="view" style="text-align: center;">
        <div class="status-icon warning">‚ö†Ô∏è</div>
        <div class="success-title">Invite Already Used</div>
        <p class="success-text">This invite link has already been claimed. Ask your friend for a new invite link.</p>
        <a href="https://app.youmio.ai/" class="btn btn-secondary" style="text-decoration: none;">Return to Youmio App</a>
      </div>

      <!-- Invalid View (for bad claim codes) -->
      <div id="view-invalid" class="view" style="text-align: center;">
        <div class="status-icon error">‚ùå</div>
        <div class="success-title">Invalid Invite</div>
        <p class="success-text">This invite link is not valid. Please check the link or request a new one.</p>
        <a href="https://app.youmio.ai/" class="btn btn-secondary" style="text-decoration: none;">Return to Youmio App</a>
      </div>

      <!-- No Invites View (for users not in system) -->
      <div id="view-no-invites" class="view" style="text-align: center;">
        <div class="status-icon warning">üéüÔ∏è</div>
        <div class="success-title">You Have No Invites</div>
        <p class="success-text">You either have no valid invites remaining or are not currently added to the invites system.</p>
        <a href="https://app.youmio.ai/" class="btn btn-secondary" style="text-decoration: none;">Return to Youmio</a>
      </div>

      <!-- Error View -->
      <div id="view-error" class="view" style="text-align: center;">
        <div class="status-icon error">‚ö†Ô∏è</div>
        <div class="success-title">Something Went Wrong</div>
        <p class="success-text">Please try again later or contact support.</p>
        <a href="https://app.youmio.ai/" class="btn btn-secondary" style="text-decoration: none;">Return to Youmio App</a>
      </div>
    </div>

    <div class="season-text">Season 1</div>
  </div>

  <!-- Wallet Selection Modal -->
  <div class="modal-overlay hidden" id="wallet-modal">
    <div class="modal">
      <div class="modal-title">Connect Wallet</div>
      
      <div class="wallet-option" id="select-metamask">
        <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask">
        <div class="wallet-option-info">
          <div class="wallet-option-name">MetaMask</div>
          <div class="wallet-option-desc" id="metamask-status">Detecting...</div>
        </div>
      </div>

      <div class="wallet-option" id="select-coinbase">
        <img src="https://altcoinsbox.com/wp-content/uploads/2022/12/coinbase-wallet-logo.webp" alt="Coinbase">
        <div class="wallet-option-info">
          <div class="wallet-option-name">Coinbase Wallet</div>
          <div class="wallet-option-desc" id="coinbase-status">Detecting...</div>
        </div>
      </div>

      <div class="wallet-option" id="select-phantom">
        <img src="https://phantom.app/img/phantom-logo.svg" alt="Phantom">
        <div class="wallet-option-info">
          <div class="wallet-option-name">Phantom</div>
          <div class="wallet-option-desc" id="phantom-status">Detecting...</div>
        </div>
      </div>

      <div class="wallet-option" id="select-trust">
        <img src="https://trustwallet.com/assets/images/media/assets/TWT.svg" alt="Trust Wallet">
        <div class="wallet-option-info">
          <div class="wallet-option-name">Trust Wallet</div>
          <div class="wallet-option-desc" id="trust-status">Detecting...</div>
        </div>
      </div>

      <div class="wallet-option" id="select-injected" style="display: none;">
        <img src="https://cdn-icons-png.flaticon.com/512/2991/2991148.png" alt="Browser Wallet">
        <div class="wallet-option-info">
          <div class="wallet-option-name">Other Wallet</div>
          <div class="wallet-option-desc">Use browser extension</div>
        </div>
      </div>

      <button class="modal-close" id="modal-close">Cancel</button>
    </div>
  </div>

  <script>
    // State
    var inviterWallet = '';
    var currentCode = '';
    var invitesRemaining = 0;
    var walletSignature = '';
    var signedMessage = '';
    var generatedCodes = [];

    // Wallet providers
    var wallets = {
      metamask: { provider: null, detected: false },
      coinbase: { provider: null, detected: false },
      phantom: { provider: null, detected: false },
      trust: { provider: null, detected: false },
      injected: { provider: null, detected: false }
    };

    function detectWallets() {
      // Handle multiple providers
      if (window.ethereum?.providers) {
        wallets.metamask.provider = window.ethereum.providers.find(function(p) { return p.isMetaMask && !p.isBraveWallet; });
        wallets.coinbase.provider = window.ethereum.providers.find(function(p) { return p.isCoinbaseWallet; });
        wallets.phantom.provider = window.ethereum.providers.find(function(p) { return p.isPhantom; });
        wallets.trust.provider = window.ethereum.providers.find(function(p) { return p.isTrust || p.isTrustWallet; });
      } else if (window.ethereum) {
        if (window.ethereum.isMetaMask && !window.ethereum.isBraveWallet) wallets.metamask.provider = window.ethereum;
        if (window.ethereum.isCoinbaseWallet) wallets.coinbase.provider = window.ethereum;
        if (window.ethereum.isPhantom) wallets.phantom.provider = window.ethereum;
        if (window.ethereum.isTrust || window.ethereum.isTrustWallet) wallets.trust.provider = window.ethereum;
      }

      // Phantom also on window.phantom.ethereum
      if (window.phantom?.ethereum) wallets.phantom.provider = window.phantom.ethereum;
      
      // Coinbase also on window.coinbaseWalletExtension
      if (window.coinbaseWalletExtension) wallets.coinbase.provider = window.coinbaseWalletExtension;

      // Fallback injected
      if (window.ethereum) wallets.injected.provider = window.ethereum;

      // Update UI
      updateWalletStatus('metamask', wallets.metamask.provider);
      updateWalletStatus('coinbase', wallets.coinbase.provider);
      updateWalletStatus('phantom', wallets.phantom.provider);
      updateWalletStatus('trust', wallets.trust.provider);

      // Show "Other" only if no specific wallet detected but ethereum exists
      var hasSpecific = wallets.metamask.provider || wallets.coinbase.provider || wallets.phantom.provider || wallets.trust.provider;
      if (!hasSpecific && wallets.injected.provider) {
        document.getElementById('select-injected').style.display = 'flex';
      } else if (!wallets.injected.provider) {
        document.getElementById('select-injected').classList.add('disabled');
      } else {
        document.getElementById('select-injected').style.display = 'none';
      }
    }

    function updateWalletStatus(id, provider) {
      var el = document.getElementById('select-' + id);
      var statusEl = document.getElementById(id + '-status');
      
      if (provider) {
        statusEl.textContent = 'Available';
        statusEl.style.color = '#4ade80';
        wallets[id].detected = true;
      } else {
        statusEl.textContent = 'Not detected';
        el.classList.add('disabled');
      }
    }

    function showModal() {
      document.getElementById('wallet-modal').classList.remove('hidden');
    }

    function hideModal() {
      document.getElementById('wallet-modal').classList.add('hidden');
    }

    async function connectWithProvider(provider) {
      if (!provider) {
        document.getElementById('verify-error').textContent = 'Wallet not available';
        document.getElementById('verify-error').classList.add('show');
        return;
      }

      hideModal();
      var btn = document.getElementById('connect-wallet-btn');
      var errorEl = document.getElementById('verify-error');
      errorEl.classList.remove('show');

      btn.disabled = true;
      btn.innerHTML = '<span>Connecting...</span>';

      try {
        var accounts = await provider.request({ method: 'eth_requestAccounts' });
        var connectedAddress = accounts[0];

        if (connectedAddress.toLowerCase() !== inviterWallet.toLowerCase()) {
          errorEl.textContent = 'Wrong wallet connected. Please connect: ' + inviterWallet.slice(0, 6) + '...' + inviterWallet.slice(-4);
          errorEl.classList.add('show');
          btn.disabled = false;
          btn.innerHTML = '<svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg> Connect Wallet & Sign';
          return;
        }

        btn.innerHTML = '<span>Sign message...</span>';

        signedMessage = 'Verify wallet ownership for Youmio Invites\n\nWallet: ' + inviterWallet + '\nTimestamp: ' + Date.now();
        
        var ethersProvider = new ethers.BrowserProvider(provider);
        var signer = await ethersProvider.getSigner();
        walletSignature = await signer.signMessage(signedMessage);

        document.getElementById('invite-count').textContent = invitesRemaining + ' invites remaining';
        
        if (invitesRemaining <= 0) {
          document.getElementById('no-invites-msg').style.display = 'block';
          document.getElementById('has-invites').style.display = 'none';
        }

        await loadExistingCodes();
        showView('share');

      } catch (err) {
        console.error('Wallet error:', err);
        if (err.code === 4001) {
          errorEl.textContent = 'Request cancelled. Please try again.';
        } else {
          errorEl.textContent = err.message || 'Failed to connect. Please try again.';
        }
        errorEl.classList.add('show');
      }

      btn.disabled = false;
      btn.innerHTML = '<svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg> Connect Wallet & Sign';
    }

    function getPageType() {
      var path = window.location.pathname;
      var refMatch = path.match(/\/ref\/(0x[a-fA-F0-9]{40})/i);
      if (refMatch) return { type: 'share', wallet: refMatch[1] };
      var claimMatch = path.match(/\/claim\/([A-Za-z0-9]{6,12})/);
      if (claimMatch) return { type: 'claim', code: claimMatch[1] };
      return { type: 'invalid' };
    }

    function showView(viewName) {
      var views = ['loading', 'verify', 'share', 'claim', 'success', 'used', 'invalid', 'error', 'no-invites'];
      views.forEach(function(v) {
        var el = document.getElementById('view-' + v);
        if (el) el.classList.remove('active');
      });
      var target = document.getElementById('view-' + viewName);
      if (target) target.classList.add('active');
    }

    async function init() {
      var page = getPageType();
      
      if (page.type === 'share') {
        inviterWallet = page.wallet;
        document.getElementById('verify-wallet-display').textContent = inviterWallet.slice(0, 6) + '...' + inviterWallet.slice(-4);
        
        detectWallets();
        
        try {
          var response = await fetch('/.netlify/functions/check-invite?inviter=' + inviterWallet);
          var data = await response.json();
          if (data.valid) {
            invitesRemaining = data.invitesRemaining;
            showView('verify');
          } else {
            // Show "no invites" for users not in system or out of invites
            showView('no-invites');
          }
        } catch (err) {
          showView('error');
        }
      } else if (page.type === 'claim') {
        currentCode = page.code;
        await loadClaimView();
      } else {
        showView('invalid');
      }
    }

    async function loadClaimView() {
      try {
        var response = await fetch('/.netlify/functions/check-code?code=' + currentCode);
        var data = await response.json();
        if (data.valid) {
          document.getElementById('inviter-display').textContent = data.inviter;
          showView('claim');
        } else if (data.reason === 'already_used') {
          showView('used');
        } else {
          showView('invalid');
        }
      } catch (err) {
        showView('error');
      }
    }

    async function loadExistingCodes() {
      try {
        var response = await fetch('/.netlify/functions/get-codes?inviter=' + inviterWallet);
        var data = await response.json();
        if (data.codes && data.codes.length > 0) {
          generatedCodes = data.codes;
          renderCodes();
        }
      } catch (err) {
        console.error('Error loading codes:', err);
      }
    }

    function renderCodes() {
      var container = document.getElementById('codes-container');
      if (generatedCodes.length === 0) {
        container.innerHTML = '';
        return;
      }

      var html = '<div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-bottom: 10px;">Your invite links:</div>';
      generatedCodes.forEach(function(code, index) {
        var link = 'https://invite.youmio.ai/claim/' + code.code;
        var status = code.used ? '<span style="color: #f87171;">Used</span>' : '<span style="color: #4ade80;">Active</span>';
        html += '<div class="code-item">' +
          '<div class="code-link">' + link + '</div>' +
          '<div style="font-size: 11px; margin-right: 8px;">' + status + '</div>' +
          '<button class="code-copy" onclick="copyCode(\'' + link + '\', this)">Copy</button>' +
        '</div>';
      });
      container.innerHTML = html;
    }

    function copyCode(link, btn) {
      navigator.clipboard.writeText(link);
      btn.textContent = '‚úì';
      btn.classList.add('copied');
      setTimeout(function() {
        btn.textContent = 'Copy';
        btn.classList.remove('copied');
      }, 2000);
    }

    async function generateCode() {
      var btn = document.getElementById('generate-btn');
      var errorEl = document.getElementById('generate-error');
      errorEl.classList.remove('show');

      if (!walletSignature) {
        errorEl.textContent = 'Please verify your wallet first.';
        errorEl.classList.add('show');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Generating...';

      try {
        var response = await fetch('/.netlify/functions/generate-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            inviter: inviterWallet,
            signature: walletSignature,
            message: signedMessage
          })
        });

        var data = await response.json();

        if (data.success) {
          generatedCodes.unshift({ code: data.code, used: false });
          renderCodes();
          invitesRemaining = data.invitesRemaining;
          document.getElementById('invite-count').textContent = invitesRemaining + ' invites remaining';
          
          if (invitesRemaining <= 0) {
            document.getElementById('no-invites-msg').style.display = 'block';
            document.getElementById('has-invites').style.display = 'none';
          }
        } else {
          errorEl.textContent = data.error || 'Failed to generate invite.';
          errorEl.classList.add('show');
        }
      } catch (err) {
        console.error('Error generating:', err);
        errorEl.textContent = 'Network error. Please try again.';
        errorEl.classList.add('show');
      }

      btn.disabled = false;
      btn.textContent = '‚ú® Generate Invite Link';
    }

    async function submitWallet() {
      var walletInput = document.getElementById('wallet-input');
      var submitBtn = document.getElementById('submit-btn');
      var errorEl = document.getElementById('claim-error');
      var wallet = walletInput.value.trim();

      errorEl.classList.remove('show');

      if (!wallet) {
        errorEl.textContent = 'Please enter your wallet address.';
        errorEl.classList.add('show');
        return;
      }

      if (!/^0x[a-fA-F0-9]{40}$/.test(wallet)) {
        errorEl.textContent = 'Invalid wallet address format.';
        errorEl.classList.add('show');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Claiming...';

      try {
        var response = await fetch('/.netlify/functions/claim-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code: currentCode,
            invitee: wallet
          })
        });

        var data = await response.json();

        if (data.success) {
          document.getElementById('success-wallet').textContent = wallet;
          showView('success');
        } else {
          if (data.reason === 'already_used') {
            showView('used');
          } else if (data.reason === 'already_invited') {
            errorEl.textContent = 'This wallet has already been invited.';
            errorEl.classList.add('show');
          } else if (data.reason === 'already_allowlisted') {
            errorEl.textContent = 'This wallet is already on the allowlist.';
            errorEl.classList.add('show');
          } else if (data.reason === 'self_invite') {
            errorEl.textContent = 'You cannot invite yourself.';
            errorEl.classList.add('show');
          } else {
            errorEl.textContent = data.error || 'Failed to claim. Please try again.';
            errorEl.classList.add('show');
          }
        }
      } catch (err) {
        console.error('Error:', err);
        errorEl.textContent = 'Network error. Please try again.';
        errorEl.classList.add('show');
      }

      submitBtn.disabled = false;
      submitBtn.textContent = 'Claim Your Access';
    }

    // Event listeners
    document.getElementById('connect-wallet-btn').addEventListener('click', showModal);
    document.getElementById('modal-close').addEventListener('click', hideModal);
    document.getElementById('wallet-modal').addEventListener('click', function(e) {
      if (e.target.id === 'wallet-modal') hideModal();
    });

    document.getElementById('select-metamask').addEventListener('click', function() {
      if (wallets.metamask.provider) connectWithProvider(wallets.metamask.provider);
    });
    document.getElementById('select-coinbase').addEventListener('click', function() {
      if (wallets.coinbase.provider) connectWithProvider(wallets.coinbase.provider);
    });
    document.getElementById('select-phantom').addEventListener('click', function() {
      if (wallets.phantom.provider) connectWithProvider(wallets.phantom.provider);
    });
    document.getElementById('select-trust').addEventListener('click', function() {
      if (wallets.trust.provider) connectWithProvider(wallets.trust.provider);
    });
    document.getElementById('select-injected').addEventListener('click', function() {
      if (wallets.injected.provider) connectWithProvider(wallets.injected.provider);
    });

    document.getElementById('generate-btn').addEventListener('click', generateCode);
    document.getElementById('submit-btn').addEventListener('click', submitWallet);
    document.getElementById('wallet-input').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') submitWallet();
    });

    // Initialize
    init();
  </script>
</body>
</html>
