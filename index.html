<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Youmio Season 1 Invite</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: #fff;
    }

    .logo {
      margin-bottom: 30px;
      text-align: center;
    }

    .logo-text {
      font-size: 32px;
      font-weight: 700;
      background: linear-gradient(135deg, #f8a4d0 0%, #a855f7 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 24px;
      padding: 32px;
      max-width: 420px;
      width: 100%;
      backdrop-filter: blur(20px);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 28px;
    }

    .icon-box {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .card-title { font-size: 22px; font-weight: 700; }
    .card-subtitle { font-size: 14px; color: rgba(255,255,255,0.5); margin-top: 4px; }

    .section { text-align: center; padding: 20px 0; }
    .lock-icon { font-size: 64px; margin-bottom: 16px; }
    .section-title { font-size: 20px; font-weight: 700; margin-bottom: 12px; }
    .section-desc { font-size: 14px; color: rgba(255,255,255,0.6); line-height: 1.6; }

    .wallet-display {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 16px;
      margin: 20px 0;
    }
    .wallet-label { font-size: 12px; color: rgba(255,255,255,0.5); margin-bottom: 6px; }
    .wallet-address { font-size: 18px; font-weight: 600; font-family: monospace; }

    .btn {
      width: 100%;
      padding: 16px 24px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(168,85,247,0.4);
    }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
      margin-top: 12px;
    }
    .btn-secondary:hover { background: rgba(255,255,255,0.15); }

    .error-msg {
      color: #f87171;
      font-size: 14px;
      text-align: center;
      margin-top: 16px;
      display: none;
    }
    .error-msg.show { display: block; }

    .success-box {
      background: rgba(34,197,94,0.1);
      border: 1px solid rgba(34,197,94,0.3);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      text-align: center;
    }
    .success-box .check { font-size: 32px; margin-bottom: 8px; }
    .success-box p { color: #4ade80; font-weight: 600; }

    .invite-link-box {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .invite-link-box label { font-size: 12px; color: rgba(255,255,255,0.5); display: block; margin-bottom: 8px; }
    .invite-link {
      width: 100%;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 12px;
      color: #a855f7;
      font-size: 14px;
      font-family: monospace;
      word-break: break-all;
    }

    .btn-row { display: flex; gap: 12px; margin-top: 16px; }
    .btn-row .btn { flex: 1; }
    .btn-copy { background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%); color: white; }
    .btn-twitter { background: #1DA1F2; color: white; }

    .invites-remaining {
      text-align: center;
      padding: 12px;
      background: rgba(168,85,247,0.1);
      border-radius: 8px;
      margin-top: 16px;
      font-size: 14px;
      color: rgba(255,255,255,0.7);
    }
    .invites-remaining strong { color: #a855f7; }

    .hidden { display: none !important; }

    .input-group { margin-bottom: 20px; }
    .input-group label { display: block; font-size: 14px; margin-bottom: 8px; color: rgba(255,255,255,0.7); }
    .input-group input {
      width: 100%;
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.3);
      color: white;
      font-size: 16px;
      font-family: monospace;
    }
    .input-group input:focus { outline: none; border-color: #a855f7; }
    .input-group input::placeholder { color: rgba(255,255,255,0.3); }

    .invited-by {
      text-align: center;
      padding: 16px;
      background: rgba(168,85,247,0.1);
      border-radius: 12px;
      margin-bottom: 20px;
    }
    .invited-by span { color: rgba(255,255,255,0.6); font-size: 14px; }
    .invited-by strong { color: #a855f7; display: block; margin-top: 4px; font-family: monospace; }

    /* Wallet Selection Modal */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal-overlay.hidden { display: none; }
    
    .modal {
      background: #1a1a2e;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 24px;
      max-width: 380px;
      width: 100%;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 20px;
    }
    .wallet-option {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 10px;
    }
    .wallet-option:hover {
      background: rgba(255,255,255,0.1);
      border-color: #a855f7;
    }
    .wallet-option img {
      width: 40px;
      height: 40px;
      border-radius: 10px;
    }
    .wallet-option-info { flex: 1; }
    .wallet-option-name { font-weight: 600; font-size: 15px; }
    .wallet-option-desc { font-size: 12px; color: rgba(255,255,255,0.5); }
    .wallet-option.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .wallet-option.disabled:hover {
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.1);
    }
    .modal-close {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      color: rgba(255,255,255,0.6);
      font-size: 14px;
      cursor: pointer;
    }
    .modal-close:hover { background: rgba(255,255,255,0.05); }

    .mobile-note {
      font-size: 12px;
      color: rgba(255,255,255,0.4);
      text-align: center;
      margin-top: 16px;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="logo">
    <div class="logo-text">youmio</div>
  </div>

  <div class="card">
    <div class="card-header">
      <div class="icon-box">üé´</div>
      <div>
        <div class="card-title">Invite a Friend to Season 1</div>
        <div class="card-subtitle" id="header-subtitle">Verify wallet to continue</div>
      </div>
    </div>

    <!-- Verification Screen -->
    <div id="verify-screen">
      <div class="section">
        <div class="lock-icon">üîê</div>
        <div class="section-title">Verify You Own This Wallet</div>
        <div class="section-desc">To generate invite links, please connect your wallet and sign a message to prove ownership.</div>
      </div>

      <div class="wallet-display">
        <div class="wallet-label">Wallet to verify</div>
        <div class="wallet-address" id="wallet-to-verify">0x0000...0000</div>
      </div>

      <button class="btn btn-primary" id="connect-wallet-btn">
        üîó Connect Wallet & Sign
      </button>
      
      <div class="mobile-note">
        üì± On mobile? Open this link in your wallet app's browser (MetaMask, Coinbase, Trust Wallet, etc.)
      </div>

      <div class="error-msg" id="verify-error"></div>
    </div>

    <!-- Generate Screen (after verification) -->
    <div id="generate-screen" class="hidden">
      <div class="success-box">
        <div class="check">‚úì</div>
        <p>Wallet Verified!</p>
      </div>

      <button class="btn btn-primary" id="generate-btn">
        ‚ú® Generate Invite Link
      </button>

      <div class="invites-remaining" id="invites-info">
        You have <strong id="invites-count">-</strong> invites remaining
      </div>

      <div class="error-msg" id="generate-error"></div>
    </div>

    <!-- Share Screen (after generating) -->
    <div id="share-screen" class="hidden">
      <div class="invite-link-box">
        <label>Your invite link</label>
        <div class="invite-link" id="invite-link">https://...</div>
      </div>

      <div class="btn-row">
        <button class="btn btn-copy" id="copy-btn">üìã Copy</button>
        <button class="btn btn-twitter" id="twitter-btn">ùïè Share</button>
      </div>

      <button class="btn btn-secondary" id="generate-another-btn">
        Generate Another Link
      </button>

      <div class="invites-remaining">
        You have <strong id="invites-count-2">-</strong> invites remaining
      </div>
    </div>

    <!-- Claim Screen (for invited users) -->
    <div id="claim-screen" class="hidden">
      <div class="invited-by">
        <span>You've been invited by</span>
        <strong id="inviter-address">0x0000...0000</strong>
      </div>

      <div class="input-group">
        <label>Enter your wallet address to claim access</label>
        <input type="text" id="wallet-input" placeholder="0x..." autocomplete="off" spellcheck="false">
      </div>

      <button class="btn btn-primary" id="submit-btn">
        Claim Your Access
      </button>

      <div class="error-msg" id="claim-error"></div>
    </div>
  </div>

  <!-- Wallet Selection Modal -->
  <div class="modal-overlay hidden" id="wallet-modal">
    <div class="modal">
      <div class="modal-title">Connect Wallet</div>
      
      <div class="wallet-option" id="select-metamask">
        <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask">
        <div class="wallet-option-info">
          <div class="wallet-option-name">MetaMask</div>
          <div class="wallet-option-desc" id="metamask-status">Detecting...</div>
        </div>
      </div>

      <div class="wallet-option" id="select-coinbase">
        <img src="https://altcoinsbox.com/wp-content/uploads/2022/12/coinbase-wallet-logo.webp" alt="Coinbase">
        <div class="wallet-option-info">
          <div class="wallet-option-name">Coinbase Wallet</div>
          <div class="wallet-option-desc" id="coinbase-status">Detecting...</div>
        </div>
      </div>

      <div class="wallet-option" id="select-phantom">
        <img src="https://phantom.app/img/phantom-logo.svg" alt="Phantom">
        <div class="wallet-option-info">
          <div class="wallet-option-name">Phantom</div>
          <div class="wallet-option-desc" id="phantom-status">Detecting...</div>
        </div>
      </div>

      <div class="wallet-option" id="select-trust">
        <img src="https://trustwallet.com/assets/images/media/assets/TWT.svg" alt="Trust Wallet">
        <div class="wallet-option-info">
          <div class="wallet-option-name">Trust Wallet</div>
          <div class="wallet-option-desc" id="trust-status">Detecting...</div>
        </div>
      </div>

      <div class="wallet-option" id="select-injected">
        <img src="https://cdn-icons-png.flaticon.com/512/2991/2991148.png" alt="Browser Wallet">
        <div class="wallet-option-info">
          <div class="wallet-option-name">Other Wallet</div>
          <div class="wallet-option-desc">Use browser extension</div>
        </div>
      </div>

      <button class="modal-close" id="modal-close">Cancel</button>
    </div>
  </div>

  <script>
    // State
    let walletFromUrl = null;
    let inviteCode = null;
    let verifiedSignature = null;
    let invitesRemaining = 0;
    let selectedProvider = null;

    // Wallet detection
    const wallets = {
      metamask: { provider: null, detected: false },
      coinbase: { provider: null, detected: false },
      phantom: { provider: null, detected: false },
      trust: { provider: null, detected: false },
      injected: { provider: null, detected: false }
    };

    function detectWallets() {
      // MetaMask - check for specific provider
      if (window.ethereum?.providers) {
        // Multiple providers (common with multiple extensions)
        wallets.metamask.provider = window.ethereum.providers.find(p => p.isMetaMask && !p.isBraveWallet);
        wallets.coinbase.provider = window.ethereum.providers.find(p => p.isCoinbaseWallet);
        wallets.phantom.provider = window.ethereum.providers.find(p => p.isPhantom);
        wallets.trust.provider = window.ethereum.providers.find(p => p.isTrust || p.isTrustWallet);
      } else if (window.ethereum) {
        // Single provider
        if (window.ethereum.isMetaMask && !window.ethereum.isBraveWallet) {
          wallets.metamask.provider = window.ethereum;
        }
        if (window.ethereum.isCoinbaseWallet) {
          wallets.coinbase.provider = window.ethereum;
        }
        if (window.ethereum.isPhantom) {
          wallets.phantom.provider = window.ethereum;
        }
        if (window.ethereum.isTrust || window.ethereum.isTrustWallet) {
          wallets.trust.provider = window.ethereum;
        }
      }

      // Phantom also exposes on window.phantom.ethereum
      if (window.phantom?.ethereum) {
        wallets.phantom.provider = window.phantom.ethereum;
      }

      // Coinbase also exposes on window.coinbaseWalletExtension
      if (window.coinbaseWalletExtension) {
        wallets.coinbase.provider = window.coinbaseWalletExtension;
      }

      // Fallback injected
      if (window.ethereum) {
        wallets.injected.provider = window.ethereum;
      }

      // Update UI
      updateWalletStatus('metamask', wallets.metamask.provider);
      updateWalletStatus('coinbase', wallets.coinbase.provider);
      updateWalletStatus('phantom', wallets.phantom.provider);
      updateWalletStatus('trust', wallets.trust.provider);

      // Hide "Other" if we detected a specific wallet
      const hasSpecific = wallets.metamask.provider || wallets.coinbase.provider || 
                          wallets.phantom.provider || wallets.trust.provider;
      if (!hasSpecific && wallets.injected.provider) {
        document.getElementById('select-injected').style.display = 'flex';
      } else if (!wallets.injected.provider) {
        document.getElementById('select-injected').classList.add('disabled');
        document.getElementById('select-injected').querySelector('.wallet-option-desc').textContent = 'Not detected';
      } else {
        document.getElementById('select-injected').style.display = 'none';
      }
    }

    function updateWalletStatus(id, provider) {
      const el = document.getElementById(`select-${id}`);
      const statusEl = document.getElementById(`${id}-status`);
      
      if (provider) {
        statusEl.textContent = 'Available';
        statusEl.style.color = '#4ade80';
        wallets[id].detected = true;
      } else {
        statusEl.textContent = 'Not detected';
        el.classList.add('disabled');
      }
    }

    function showModal() {
      document.getElementById('wallet-modal').classList.remove('hidden');
    }

    function hideModal() {
      document.getElementById('wallet-modal').classList.add('hidden');
    }

    async function connectWithProvider(provider) {
      if (!provider) {
        throw new Error('Wallet not available');
      }

      hideModal();
      const btn = document.getElementById('connect-wallet-btn');
      const errorEl = document.getElementById('verify-error');
      errorEl.classList.remove('show');
      btn.disabled = true;
      btn.innerHTML = 'üîÑ Connecting...';

      try {
        // Request accounts
        const accounts = await provider.request({ method: 'eth_requestAccounts' });
        
        if (!accounts || accounts.length === 0) {
          throw new Error('No accounts returned');
        }

        const connectedWallet = accounts[0].toLowerCase();
        const requiredWallet = walletFromUrl.toLowerCase();

        // Check wallet matches
        if (connectedWallet !== requiredWallet) {
          throw new Error(`Wrong wallet connected.\n\nConnected: ${connectedWallet.slice(0,6)}...${connectedWallet.slice(-4)}\nRequired: ${requiredWallet.slice(0,6)}...${requiredWallet.slice(-4)}\n\nPlease switch to the correct wallet.`);
        }

        // Sign message
        btn.innerHTML = '‚úçÔ∏è Sign message in wallet...';
        
        const message = `Verify wallet ownership for Youmio Season 1 Invites\n\nWallet: ${walletFromUrl}\nTimestamp: ${Date.now()}`;
        
        const signature = await provider.request({
          method: 'personal_sign',
          params: [message, connectedWallet]
        });

        verifiedSignature = signature;
        selectedProvider = provider;

        // Check invites remaining
        await checkInvites();

        // Show generate screen
        document.getElementById('verify-screen').classList.add('hidden');
        document.getElementById('generate-screen').classList.remove('hidden');
        document.getElementById('header-subtitle').textContent = 'Generate invite links';

      } catch (err) {
        console.error('Connection error:', err);
        errorEl.textContent = err.message || 'Failed to connect. Please try again.';
        errorEl.classList.add('show');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'üîó Connect Wallet & Sign';
      }
    }

    async function checkInvites() {
      try {
        const res = await fetch(`/.netlify/functions/check-invite?inviter=${walletFromUrl}`);
        const data = await res.json();
        
        if (data.valid) {
          invitesRemaining = data.invitesRemaining;
          document.getElementById('invites-count').textContent = invitesRemaining;
          document.getElementById('invites-count-2').textContent = invitesRemaining;
        }
      } catch (e) {
        console.error('Failed to check invites:', e);
      }
    }

    async function generateCode() {
      const btn = document.getElementById('generate-btn');
      const errorEl = document.getElementById('generate-error');
      errorEl.classList.remove('show');

      if (invitesRemaining <= 0) {
        errorEl.textContent = 'No invites remaining.';
        errorEl.classList.add('show');
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '‚è≥ Generating...';

      try {
        const res = await fetch('/.netlify/functions/generate-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            inviter: walletFromUrl,
            signature: verifiedSignature
          })
        });

        const data = await res.json();

        if (!res.ok || !data.code) {
          throw new Error(data.error || 'Failed to generate code');
        }

        inviteCode = data.code;
        invitesRemaining = data.invitesRemaining ?? (invitesRemaining - 1);

        const link = `${window.location.origin}/invite/${inviteCode}`;
        document.getElementById('invite-link').textContent = link;
        document.getElementById('invites-count').textContent = invitesRemaining;
        document.getElementById('invites-count-2').textContent = invitesRemaining;

        document.getElementById('generate-screen').classList.add('hidden');
        document.getElementById('share-screen').classList.remove('hidden');
        document.getElementById('header-subtitle').textContent = 'Share your invite';

      } catch (err) {
        errorEl.textContent = err.message;
        errorEl.classList.add('show');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '‚ú® Generate Invite Link';
      }
    }

    function generateAnother() {
      if (invitesRemaining <= 0) {
        document.getElementById('generate-error').textContent = 'No invites remaining.';
        document.getElementById('generate-error').classList.add('show');
        document.getElementById('share-screen').classList.add('hidden');
        document.getElementById('generate-screen').classList.remove('hidden');
        return;
      }
      document.getElementById('share-screen').classList.add('hidden');
      document.getElementById('generate-screen').classList.remove('hidden');
      document.getElementById('header-subtitle').textContent = 'Generate invite links';
    }

    function copyLink() {
      const link = document.getElementById('invite-link').textContent;
      navigator.clipboard.writeText(link);
      const btn = document.getElementById('copy-btn');
      btn.textContent = '‚úì Copied!';
      setTimeout(() => { btn.textContent = 'üìã Copy'; }, 2000);
    }

    function shareTwitter() {
      const link = document.getElementById('invite-link').textContent;
      const text = encodeURIComponent(`Join me in Youmio Season 1! üöÄ\n\nClaim your access:\n${link}`);
      window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
    }

    async function submitWallet() {
      const input = document.getElementById('wallet-input');
      const btn = document.getElementById('submit-btn');
      const errorEl = document.getElementById('claim-error');
      const wallet = input.value.trim();

      errorEl.classList.remove('show');

      if (!/^0x[a-fA-F0-9]{40}$/.test(wallet)) {
        errorEl.textContent = 'Please enter a valid Ethereum wallet address.';
        errorEl.classList.add('show');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Claiming...';

      try {
        const res = await fetch('/.netlify/functions/submit-invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: inviteCode, wallet })
        });

        const data = await res.json();

        if (!res.ok || !data.success) {
          throw new Error(data.error || 'Failed to claim invite');
        }

        document.getElementById('claim-screen').innerHTML = `
          <div class="success-box">
            <div class="check">üéâ</div>
            <p>You're In!</p>
          </div>
          <p style="text-align:center;color:rgba(255,255,255,0.7);line-height:1.6;">
            Your wallet has been added to the Season 1 allowlist. You'll receive access soon!
          </p>
        `;

      } catch (err) {
        errorEl.textContent = err.message;
        errorEl.classList.add('show');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Claim Your Access';
      }
    }

    function init() {
      const path = window.location.pathname;

      // /ref/{wallet} - inviter generating codes
      const refMatch = path.match(/^\/ref\/?(0x[a-fA-F0-9]{40})?$/i);
      if (refMatch) {
        walletFromUrl = refMatch[1];
        if (!walletFromUrl) {
          document.querySelector('.card').innerHTML = `
            <div style="text-align:center;padding:40px 20px;">
              <div style="font-size:48px;margin-bottom:16px;">‚ùå</div>
              <h2 style="margin-bottom:12px;">Invalid Link</h2>
              <p style="color:rgba(255,255,255,0.6);">No wallet address provided in URL.</p>
            </div>
          `;
          return;
        }
        document.getElementById('wallet-to-verify').textContent = 
          `${walletFromUrl.slice(0,6)}...${walletFromUrl.slice(-4)}`;
        
        // Detect wallets
        detectWallets();
        return;
      }

      // /invite/{code} - invitee claiming
      const inviteMatch = path.match(/^\/invite\/([A-Z0-9]+)$/i);
      if (inviteMatch) {
        inviteCode = inviteMatch[1];
        document.getElementById('verify-screen').classList.add('hidden');
        document.getElementById('claim-screen').classList.remove('hidden');
        document.getElementById('header-subtitle').textContent = 'Claim your access';
        document.querySelector('.card-title').textContent = 'You\'ve Been Invited!';
        document.querySelector('.icon-box').textContent = 'üéÅ';
        
        // Fetch inviter info
        fetch(`/.netlify/functions/get-invite?code=${inviteCode}`)
          .then(r => r.json())
          .then(data => {
            if (data.inviter) {
              document.getElementById('inviter-address').textContent = data.inviter;
            }
          })
          .catch(() => {});
        return;
      }

      // Unknown path - show error
      document.querySelector('.card').innerHTML = `
        <div style="text-align:center;padding:40px 20px;">
          <div style="font-size:48px;margin-bottom:16px;">ü§î</div>
          <h2 style="margin-bottom:12px;">Page Not Found</h2>
          <p style="color:rgba(255,255,255,0.6);">This invite link doesn't look right.</p>
        </div>
      `;
    }

    // Event listeners
    document.getElementById('connect-wallet-btn').addEventListener('click', showModal);
    document.getElementById('modal-close').addEventListener('click', hideModal);
    document.getElementById('wallet-modal').addEventListener('click', (e) => {
      if (e.target.id === 'wallet-modal') hideModal();
    });

    document.getElementById('select-metamask').addEventListener('click', () => {
      if (wallets.metamask.provider) connectWithProvider(wallets.metamask.provider);
    });
    document.getElementById('select-coinbase').addEventListener('click', () => {
      if (wallets.coinbase.provider) connectWithProvider(wallets.coinbase.provider);
    });
    document.getElementById('select-phantom').addEventListener('click', () => {
      if (wallets.phantom.provider) connectWithProvider(wallets.phantom.provider);
    });
    document.getElementById('select-trust').addEventListener('click', () => {
      if (wallets.trust.provider) connectWithProvider(wallets.trust.provider);
    });
    document.getElementById('select-injected').addEventListener('click', () => {
      if (wallets.injected.provider) connectWithProvider(wallets.injected.provider);
    });

    document.getElementById('generate-btn').addEventListener('click', generateCode);
    document.getElementById('generate-another-btn').addEventListener('click', generateAnother);
    document.getElementById('copy-btn').addEventListener('click', copyLink);
    document.getElementById('twitter-btn').addEventListener('click', shareTwitter);
    document.getElementById('submit-btn').addEventListener('click', submitWallet);
    document.getElementById('wallet-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') submitWallet();
    });

    init();
  </script>
</body>
</html>
