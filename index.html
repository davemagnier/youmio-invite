<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Youmio Season 1 Invite</title>
  <meta name="description" content="You've been invited to Youmio Season 1. Claim your access now.">
  <meta property="og:title" content="You're Invited to Youmio Season 1">
  <meta property="og:description" content="Claim your spot and start earning Affinity.">
  <meta property="og:image" content="https://youmioinvite.netlify.app/twitter-card.png">
  <meta property="og:url" content="https://youmioinvite.netlify.app">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="You're Invited to Youmio Season 1">
  <meta name="twitter:description" content="Claim your spot and start earning Affinity before it's too late.">
  <meta name="twitter:image" content="https://youmioinvite.netlify.app/twitter-card.png">
  <link rel="icon" href="/favicon.ico">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: system-ui, -apple-system, sans-serif; 
      background: #0a0a0f; 
      min-height: 100vh; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      padding: 20px; 
      flex-direction: column; 
    }
    
    .glow { position: fixed; width: 300px; height: 300px; border-radius: 50%; filter: blur(80px); pointer-events: none; z-index: 0; }
    .glow-1 { top: 20%; left: 20%; background: rgba(236,72,153,0.15); }
    .glow-2 { bottom: 20%; right: 20%; background: rgba(168,85,247,0.15); }
    
    .page-container { display: flex; flex-direction: column; align-items: center; position: relative; z-index: 1; }
    
    .logo-header { text-align: center; margin-bottom: 24px; }
    .logo-img { height: 120px; width: auto; filter: drop-shadow(0 4px 20px rgba(196, 165, 217, 0.3)); }
    
    .season-text { font-size: 26px; font-weight: 600; background: linear-gradient(135deg, #c084fc 0%, #ec4899 50%, #f97316 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: 0.05em; text-align: center; margin-top: 24px; }
    
    .card { position: relative; z-index: 1; width: 100%; max-width: 420px; background: rgba(22,22,31,0.95); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 28px; }
    
    .header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
    .icon { width: 44px; height: 44px; background: linear-gradient(135deg, #ec4899, #9333ea); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .title { color: white; font-size: 18px; font-weight: 600; }
    .subtitle { color: #9ca3af; font-size: 13px; margin-top: 2px; }
    .invite-count { color: #f9a8d4; }
    
    .inviter-box { padding: 14px; background: rgba(255,255,255,0.05); border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
    .inviter-label { color: #9ca3af; font-size: 13px; margin-bottom: 4px; }
    .inviter-addr { color: white; font-family: monospace; font-size: 15px; }
    
    .info-box { padding: 14px; background: linear-gradient(to right, rgba(236,72,153,0.1), rgba(168,85,247,0.1)); border: 1px solid rgba(236,72,153,0.2); border-radius: 10px; margin-bottom: 20px; }
    .info-text { color: #d1d5db; font-size: 13px; line-height: 1.5; }
    
    .label { display: block; color: #9ca3af; font-size: 13px; margin-bottom: 8px; }
    .input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 12px 14px; color: white; font-size: 14px; font-family: monospace; outline: none; margin-bottom: 6px; }
    .input:focus { border-color: rgba(236,72,153,0.5); }
    .input::placeholder { color: #6b7280; }
    
    .error { color: #f87171; font-size: 13px; margin-bottom: 10px; display: none; }
    .error.show { display: block; }
    
    .btn { width: 100%; padding: 14px; background: linear-gradient(to right, #ec4899, #db2777); border: none; color: white; font-weight: 600; font-size: 15px; border-radius: 10px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn:hover { filter: brightness(1.1); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-secondary { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); }
    .btn-secondary:hover { background: rgba(255,255,255,0.15); filter: none; }
    .btn-wallet { background: linear-gradient(135deg, #8b5cf6, #6366f1); }
    
    .link-box { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 14px; margin-bottom: 16px; }
    .link-text { color: white; font-family: monospace; font-size: 12px; word-break: break-all; margin-bottom: 12px; }
    .link-actions { display: flex; gap: 8px; }
    .link-btn { flex: 1; padding: 10px; border-radius: 8px; font-weight: 500; font-size: 13px; cursor: pointer; transition: all 0.2s; text-align: center; border: none; }
    .link-btn-copy { background: rgba(255,255,255,0.1); color: white; }
    .link-btn-copy:hover { background: rgba(255,255,255,0.2); }
    .link-btn-copy.copied { background: rgba(34,197,94,0.2); color: #4ade80; }
    .link-btn-twitter { background: rgba(29,161,242,0.15); color: #1DA1F2; }
    .link-btn-twitter:hover { background: rgba(29,161,242,0.25); }
    
    .success-icon { width: 64px; height: 64px; background: linear-gradient(135deg, #4ade80, #16a34a); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; }
    .success-title { color: white; font-size: 20px; font-weight: 600; text-align: center; margin-bottom: 8px; }
    .success-text { color: #9ca3af; font-size: 14px; text-align: center; margin-bottom: 20px; line-height: 1.5; }
    .wallet-box { padding: 14px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 20px; }
    
    .status-icon { width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 32px; }
    .status-icon.warning { background: rgba(234,179,8,0.2); }
    .status-icon.error { background: rgba(239,68,68,0.2); }
    .status-icon.locked { background: rgba(168,85,247,0.2); }
    
    .verify-section { text-align: center; padding: 20px 0; }
    .verify-icon { font-size: 48px; margin-bottom: 16px; }
    .verify-title { color: white; font-size: 16px; font-weight: 600; margin-bottom: 8px; }
    .verify-text { color: #9ca3af; font-size: 13px; margin-bottom: 20px; line-height: 1.5; }
    
    .spinner { animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .view { display: none; }
    .view.active { display: block; }
    
    .loading-view { text-align: center; padding: 40px 20px; }
    .loading-spinner { width: 40px; height: 40px; border: 3px solid rgba(236,72,153,0.3); border-top-color: #ec4899; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
    .loading-text { color: #9ca3af; font-size: 14px; }
    .no-invites-text { color: #9ca3af; font-size: 14px; text-align: center; padding: 20px 0; }

    .codes-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px; max-height: 280px; overflow-y: auto; }
    .code-row { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 12px; }
    .code-number { font-size: 12px; font-weight: 600; color: #ec4899; min-width: 24px; }
    .code-link { flex: 1; font-size: 11px; font-family: monospace; color: rgba(255,255,255,0.8); word-break: break-all; line-height: 1.4; }
    .btn-copy-small { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 6px 10px; color: white; cursor: pointer; font-size: 13px; transition: all 0.2s; }
    .btn-copy-small:hover { background: rgba(255,255,255,0.2); }
    .btn-copy-small.copied { background: rgba(34,197,94,0.2); color: #4ade80; }
    .btn-twitter-small { background: rgba(29,161,242,0.15); border: 1px solid rgba(29,161,242,0.2); border-radius: 6px; padding: 6px 10px; color: #1DA1F2; cursor: pointer; font-size: 13px; transition: all 0.2s; }
    .btn-twitter-small:hover { background: rgba(29,161,242,0.25); }

    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal-overlay.hidden { display: none; }
    .modal { background: rgba(22,22,31,0.98); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 24px; max-width: 380px; width: 100%; }
    .modal-title { color: white; font-size: 18px; font-weight: 600; text-align: center; margin-bottom: 20px; }
    .wallet-option { display: flex; align-items: center; gap: 14px; padding: 14px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; cursor: pointer; transition: all 0.2s; margin-bottom: 10px; }
    .wallet-option:hover { background: rgba(255,255,255,0.1); border-color: #ec4899; }
    .wallet-option.disabled { opacity: 0.4; cursor: not-allowed; }
    .wallet-option.disabled:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.08); }
    .wallet-option img { width: 40px; height: 40px; border-radius: 10px; }
    .wallet-option-info { flex: 1; }
    .wallet-option-name { color: white; font-weight: 600; font-size: 15px; }
    .wallet-option-desc { font-size: 12px; color: #9ca3af; }
    .wallet-option-desc.available { color: #4ade80; }
    .modal-close { width: 100%; padding: 12px; margin-top: 10px; background: transparent; border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; color: #9ca3af; font-size: 14px; cursor: pointer; }
    .modal-close:hover { background: rgba(255,255,255,0.05); }
    .mobile-note { font-size: 12px; color: #6b7280; text-align: center; margin-top: 16px; line-height: 1.5; }

    @media (max-width: 480px) {
      .card { padding: 20px; }
      .link-actions { flex-direction: column; }
      .code-link { font-size: 10px; }
    }
  </style>
</head>
<body>
  <div class="glow glow-1"></div>
  <div class="glow glow-2"></div>

  <div class="page-container">
    <div class="logo-header">
      <img src="/youmio-logo.png" alt="Youmio" class="logo-img" onerror="this.src='/logo.png';">
    </div>

    <div class="card">
      <!-- Loading State -->
      <div id="view-loading" class="view active">
        <div class="loading-view">
          <div class="loading-spinner"></div>
          <p class="loading-text">Loading...</p>
        </div>
      </div>

      <!-- NOT ON LIST View (NEW) -->
      <div id="view-not-on-list" class="view" style="text-align: center;">
        <div class="status-icon locked">üîí</div>
        <div class="success-title">Not on the Invite List</div>
        <p class="success-text">Your wallet address is not on the list of addresses granted invites for Season 1.</p>
        <div class="inviter-box" style="margin-bottom: 20px;">
          <div class="inviter-label">Wallet checked</div>
          <div class="inviter-addr" id="not-on-list-wallet"></div>
        </div>
        <a href="https://app.youmio.ai/" class="btn btn-secondary" style="text-decoration: none;">Return to Youmio</a>
      </div>

      <!-- Verify Wallet View -->
      <div id="view-verify" class="view">
        <div class="header">
          <div class="icon">
            <svg width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="white"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/></svg>
          </div>
          <div>
            <div class="title">Invite a Friend to Season 1</div>
            <div class="subtitle">Verify wallet to continue</div>
          </div>
        </div>

        <div class="verify-section">
          <div class="verify-icon">üîê</div>
          <div class="verify-title">Verify You Own This Wallet</div>
          <div class="verify-text">To generate invite links, please connect your wallet and sign a message to prove ownership.</div>
          <div class="inviter-box" style="text-align: left; margin-bottom: 20px;">
            <div class="inviter-label">Wallet to verify</div>
            <div class="inviter-addr" id="verify-wallet-display"></div>
          </div>
          <button class="btn btn-wallet" id="connect-wallet-btn">
            <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>
            Connect Wallet &amp; Sign
          </button>
          <p class="mobile-note">üì± On mobile? Open this link in your wallet app's browser</p>
          <p id="verify-error" class="error" style="margin-top: 12px; text-align: center;"></p>
        </div>
      </div>

      <!-- Share View (after verification) -->
      <div id="view-share" class="view">
        <div class="header">
          <div class="icon">
            <svg width="24" height="24" fill="white" viewBox="0 0 24 24"><path d="M15 14c-2.67 0-8 1.33-8 4v2h16v-2c0-2.67-5.33-4-8-4zm0-2c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9 2V12H4v2H2v2h2v2h2v-2h2v-2H6z"/></svg>
          </div>
          <div>
            <div class="title">Invite a Friend to Season 1</div>
            <div class="subtitle invite-count" id="invite-count">Loading...</div>
          </div>
        </div>

        <div class="info-box">
          <p class="info-text">Generate unique invite links for your friends. Each link can only be used once.</p>
        </div>

        <div id="no-invites" style="display: none;">
          <p class="no-invites-text">You've used all your invites. Thanks for spreading the word!</p>
        </div>

        <div id="generate-section">
          <button class="btn" id="generate-btn">
            <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            Generate Invite Link
          </button>
          <p id="generate-error" class="error" style="margin-top: 12px; text-align: center;"></p>
        </div>

        <div id="generated-links-section" style="display: none; margin-top: 20px;">
          <label class="label">Your invite links (one-time use each)</label>
          <div id="codes-list" class="codes-list"></div>
          <div id="copy-all-container" style="display: none;">
            <button class="btn btn-secondary" id="copy-all-btn">üìã Copy All Links</button>
          </div>
        </div>
      </div>

      <!-- Claim View (for invitee) -->
      <div id="view-claim" class="view">
        <div class="header">
          <div class="icon">
            <svg width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="white"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/></svg>
          </div>
          <div>
            <div class="title">Youmio App Season 1 Invite</div>
            <div class="subtitle">You've been invited to Youmio</div>
          </div>
        </div>
        <div class="inviter-box">
          <div class="inviter-label">Invited by</div>
          <div class="inviter-addr" id="inviter-display">0x6117...E6e8</div>
        </div>
        <label class="label">Your Wallet Address</label>
        <input type="text" id="wallet-input" class="input" placeholder="0x...">
        <p id="error-msg" class="error"></p>
        <button class="btn" id="submit-btn">Claim Your Access</button>
        <div class="info-box" style="margin-top: 16px;">
          <p class="info-text">‚ÑπÔ∏è Season 1 is invite-only. Once you claim your invite, you'll be able to access the app and have the ability to earn Affinity which will unlock Youmio Ecosystem Rewards in the future.</p>
        </div>
      </div>

      <!-- Success View -->
      <div id="view-success" class="view">
        <div class="success-icon">
          <svg width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
        </div>
        <div class="success-title">Access Claimed!</div>
        <p class="success-text">Your wallet will be added to the Season 1 allowlist. This usually takes about a minute to activate.</p>
        <div class="wallet-box">
          <div class="inviter-label">Your wallet</div>
          <div class="inviter-addr" id="success-wallet" style="font-size: 13px; word-break: break-all;"></div>
        </div>
        <a href="https://app.youmio.ai/" class="btn" style="text-decoration: none;">Return to Youmio App</a>
      </div>

      <!-- Used View -->
      <div id="view-used" class="view" style="text-align: center;">
        <div class="status-icon warning">‚ö†Ô∏è</div>
        <div class="success-title">Invite Already Used</div>
        <p class="success-text">This invite link has already been claimed. Ask your friend for a new invite link.</p>
        <a href="https://app.youmio.ai/" class="btn btn-secondary" style="text-decoration: none;">Return to Youmio App</a>
      </div>

      <!-- Invalid View (for bad claim codes only) -->
      <div id="view-invalid" class="view" style="text-align: center;">
        <div class="status-icon error">‚ùå</div>
        <div class="success-title">Invalid Invite Code</div>
        <p class="success-text">This invite code is not valid. Please check the link or request a new one from your friend.</p>
        <a href="https://app.youmio.ai/" class="btn btn-secondary" style="text-decoration: none;">Return to Youmio App</a>
      </div>

      <!-- Error View -->
      <div id="view-error" class="view" style="text-align: center;">
        <div class="status-icon error">‚ö†Ô∏è</div>
        <div class="success-title">Something Went Wrong</div>
        <p class="success-text">Please try again later or contact support.</p>
        <a href="https://app.youmio.ai/" class="btn btn-secondary" style="text-decoration: none;">Return to Youmio App</a>
      </div>
    </div>

    <div class="season-text">Season 1</div>
  </div>

  <!-- Wallet Selection Modal -->
  <div class="modal-overlay hidden" id="wallet-modal">
    <div class="modal">
      <div class="modal-title">Connect Wallet</div>
      
      <div class="wallet-option" id="select-metamask">
        <img src="https://raw.githubusercontent.com/MetaMask/brand-resources/refs/heads/master/SVG/SVG_MetaMask_Icon_Color.svg" alt="MetaMask" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><rect fill=%22%23F5841F%22 width=%2240%22 height=%2240%22 rx=%228%22/><text x=%2220%22 y=%2226%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2216%22 font-weight=%22bold%22>M</text></svg>'">
        <div class="wallet-option-info">
          <div class="wallet-option-name">MetaMask</div>
          <div class="wallet-option-desc" id="metamask-status">Detecting...</div>
        </div>
      </div>

      <div class="wallet-option" id="select-coinbase">
        <img src="https://www.coinbase.com/img/favicon/favicon-256.png" alt="Coinbase" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><rect fill=%22%230052FF%22 width=%2240%22 height=%2240%22 rx=%228%22/><text x=%2220%22 y=%2226%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2216%22 font-weight=%22bold%22>C</text></svg>'">
        <div class="wallet-option-info">
          <div class="wallet-option-name">Coinbase Wallet</div>
          <div class="wallet-option-desc" id="coinbase-status">Detecting...</div>
        </div>
      </div>

      <div class="wallet-option" id="select-phantom">
        <img src="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><rect fill=%22%235346b4%22 width=%2240%22 height=%2240%22 rx=%228%22/><text x=%2220%22 y=%2226%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2216%22 font-weight=%22bold%22>P</text></svg>" alt="Phantom">
        <div class="wallet-option-info">
          <div class="wallet-option-name">Phantom</div>
          <div class="wallet-option-desc" id="phantom-status">Detecting...</div>
        </div>
      </div>

      <div class="wallet-option" id="select-rabby">
        <img src="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><rect fill=%22%238697FF%22 width=%2240%22 height=%2240%22 rx=%228%22/><text x=%2220%22 y=%2226%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2216%22 font-weight=%22bold%22>R</text></svg>" alt="Rabby">
        <div class="wallet-option-info">
          <div class="wallet-option-name">Rabby Wallet</div>
          <div class="wallet-option-desc" id="rabby-status">Detecting...</div>
        </div>
      </div>

      <div class="wallet-option" id="select-injected" style="display: none;">
        <img src="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><rect fill=%22%23666%22 width=%2240%22 height=%2240%22 rx=%228%22/><text x=%2220%22 y=%2226%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2216%22 font-weight=%22bold%22>W</text></svg>" alt="Browser Wallet">
        <div class="wallet-option-info">
          <div class="wallet-option-name">Other Wallet</div>
          <div class="wallet-option-desc">Use browser extension</div>
        </div>
      </div>

      <button class="modal-close" id="modal-close">Cancel</button>
    </div>
  </div>

  <script>
    // State
    var inviterWallet = '';
    var currentCode = '';
    var invitesRemaining = 0;
    var walletSignature = '';
    var signedMessage = '';
    var generatedCodes = [];
    var allowZeroInvites = false; // Flag for users with 0 invites but existing codes

    // Wallet providers
    var wallets = {
      metamask: { provider: null, detected: false },
      coinbase: { provider: null, detected: false },
      phantom: { provider: null, detected: false },
      rabby: { provider: null, detected: false },
      injected: { provider: null, detected: false }
    };

    function detectWallets() {
      if (window.ethereum?.providers) {
        wallets.metamask.provider = window.ethereum.providers.find(function(p) { return p.isMetaMask && !p.isBraveWallet; });
        wallets.coinbase.provider = window.ethereum.providers.find(function(p) { return p.isCoinbaseWallet; });
        wallets.phantom.provider = window.ethereum.providers.find(function(p) { return p.isPhantom; });
        wallets.rabby.provider = window.ethereum.providers.find(function(p) { return p.isRabby; });
      } else if (window.ethereum) {
        if (window.ethereum.isMetaMask && !window.ethereum.isBraveWallet) wallets.metamask.provider = window.ethereum;
        if (window.ethereum.isCoinbaseWallet) wallets.coinbase.provider = window.ethereum;
        if (window.ethereum.isPhantom) wallets.phantom.provider = window.ethereum;
        if (window.ethereum.isRabby) wallets.rabby.provider = window.ethereum;
      }
      if (window.phantom?.ethereum) wallets.phantom.provider = window.phantom.ethereum;
      if (window.coinbaseWalletExtension) wallets.coinbase.provider = window.coinbaseWalletExtension;
      if (window.ethereum) wallets.injected.provider = window.ethereum;

      updateWalletStatus('metamask');
      updateWalletStatus('coinbase');
      updateWalletStatus('phantom');
      updateWalletStatus('rabby');

      var hasSpecific = wallets.metamask.provider || wallets.coinbase.provider || wallets.phantom.provider || wallets.rabby.provider;
      if (!hasSpecific && wallets.injected.provider) {
        document.getElementById('select-injected').style.display = 'flex';
      }
    }

    function updateWalletStatus(id) {
      var el = document.getElementById('select-' + id);
      var statusEl = document.getElementById(id + '-status');
      if (wallets[id].provider) {
        statusEl.textContent = 'Available';
        statusEl.classList.add('available');
        wallets[id].detected = true;
      } else {
        statusEl.textContent = 'Not detected';
        el.classList.add('disabled');
      }
    }

    function showModal() { document.getElementById('wallet-modal').classList.remove('hidden'); }
    function hideModal() { document.getElementById('wallet-modal').classList.add('hidden'); }

    async function connectWithProvider(provider) {
      if (!provider) return;
      hideModal();
      var btn = document.getElementById('connect-wallet-btn');
      var errorEl = document.getElementById('verify-error');
      errorEl.classList.remove('show');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner">‚è≥</span> Connecting...';

      try {
        var accounts = await provider.request({ method: 'eth_requestAccounts' });
        if (!accounts || accounts.length === 0) throw new Error('No accounts returned');

        var connectedWallet = accounts[0].toLowerCase();
        var requiredWallet = inviterWallet.toLowerCase();

        if (connectedWallet !== requiredWallet) {
          throw new Error('Wrong wallet connected.\n\nConnected: ' + connectedWallet.slice(0,6) + '...' + connectedWallet.slice(-4) + '\nRequired: ' + requiredWallet.slice(0,6) + '...' + requiredWallet.slice(-4) + '\n\nPlease switch to the correct wallet.');
        }

        btn.innerHTML = '<span class="spinner">‚è≥</span> Sign message in wallet...';

        var timestamp = Math.floor(Date.now() / 1000);
        var message = 'Youmio Season 1 Invite Verification\n\nI am verifying ownership of this wallet to generate invite links.\n\nWallet: ' + inviterWallet.slice(0, 6) + '...' + inviterWallet.slice(-4) + '\nTimestamp: ' + timestamp;

        var signature = await provider.request({
          method: 'personal_sign',
          params: [message, connectedWallet]
        });

        walletSignature = signature;
        signedMessage = message;
        
        // Load any existing codes for this wallet
        await loadExistingCodes();

        document.getElementById('invite-count').textContent = invitesRemaining + (invitesRemaining === 1 ? ' Invite Remaining' : ' Invites Remaining');
        
        // Show/hide generate button based on remaining invites
        if (invitesRemaining <= 0) {
          document.getElementById('no-invites').style.display = 'block';
          document.getElementById('generate-section').style.display = 'none';
        } else {
          document.getElementById('no-invites').style.display = 'none';
          document.getElementById('generate-section').style.display = 'block';
        }
        
        showView('share');
      } catch (err) {
        console.error('Wallet connection error:', err);
        if (err.code === 4001) {
          errorEl.textContent = 'You rejected the request. Please try again.';
        } else {
          errorEl.textContent = err.message || 'Failed to connect wallet. Please try again.';
        }
        errorEl.classList.add('show');
      }

      btn.disabled = false;
      btn.innerHTML = '<svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg> Connect Wallet &amp; Sign';
    }

    function getPageType() {
      var path = window.location.pathname;
      var refMatch = path.match(/\/ref\/(0x[a-fA-F0-9]{40})/i);
      if (refMatch) return { type: 'share', wallet: refMatch[1] };
      var claimMatch = path.match(/\/claim\/([A-Za-z0-9]{6,12})/);
      if (claimMatch) return { type: 'claim', code: claimMatch[1] };
      return { type: 'invalid' };
    }

    function showView(viewName) {
      var views = ['loading', 'verify', 'share', 'claim', 'success', 'used', 'invalid', 'error', 'not-on-list'];
      views.forEach(function(v) {
        var el = document.getElementById('view-' + v);
        if (el) el.classList.remove('active');
      });
      var target = document.getElementById('view-' + viewName);
      if (target) target.classList.add('active');
    }

    async function init() {
      var page = getPageType();
      
      if (page.type === 'share') {
        inviterWallet = page.wallet;
        document.getElementById('verify-wallet-display').textContent = inviterWallet.slice(0, 6) + '...' + inviterWallet.slice(-4);
        document.getElementById('not-on-list-wallet').textContent = inviterWallet.slice(0, 6) + '...' + inviterWallet.slice(-4);
        
        detectWallets();
        
        try {
          var response = await fetch('/.netlify/functions/check-invite?inviter=' + inviterWallet);
          var data = await response.json();
          
          if (data.valid) {
            // Wallet is on allowlist with invites remaining
            invitesRemaining = data.invitesRemaining;
            showView('verify');
          } else if (data.reason === 'no_invites') {
            // Wallet is on allowlist but has 0 invites - still let them verify to see existing codes
            invitesRemaining = 0;
            allowZeroInvites = true;
            showView('verify');
          } else if (data.reason === 'not_allowlisted') {
            // Wallet is NOT on the allowlist at all
            showView('not-on-list');
          } else {
            // Unknown error
            showView('not-on-list');
          }
        } catch (err) {
          console.error('Error checking invite:', err);
          showView('error');
        }
      } else if (page.type === 'claim') {
        currentCode = page.code;
        await loadClaimView();
      } else {
        showView('invalid');
      }
    }

    async function loadExistingCodes() {
      try {
        var response = await fetch('/.netlify/functions/get-codes?inviter=' + inviterWallet);
        var data = await response.json();
        
        if (data.success && data.codes && data.codes.length > 0) {
          generatedCodes = data.codes;
          displayGeneratedCodes();
          document.getElementById('generated-links-section').style.display = 'block';
          
          if (generatedCodes.length > 1) {
            document.getElementById('copy-all-container').style.display = 'block';
          }
        }
      } catch (err) {
        console.error('Error loading existing codes:', err);
      }
    }

    async function loadClaimView() {
      try {
        var response = await fetch('/.netlify/functions/check-code?code=' + currentCode);
        var data = await response.json();
        if (data.valid) {
          document.getElementById('inviter-display').textContent = data.inviter;
          showView('claim');
        } else if (data.reason === 'already_used') {
          showView('used');
        } else {
          showView('invalid');
        }
      } catch (err) {
        showView('error');
      }
    }

    async function generateCode() {
      var btn = document.getElementById('generate-btn');
      var errorEl = document.getElementById('generate-error');
      errorEl.classList.remove('show');

      if (!walletSignature) {
        errorEl.textContent = 'Signature missing. Please refresh and verify again.';
        errorEl.classList.add('show');
        return;
      }
      if (invitesRemaining <= 0) {
        errorEl.textContent = 'No invites remaining.';
        errorEl.classList.add('show');
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner">‚è≥</span> Generating...';

      try {
        var response = await fetch('/.netlify/functions/generate-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            inviter: inviterWallet,
            signature: walletSignature,
            message: signedMessage
          })
        });
        var data = await response.json();

        if (data.success && data.code) {
          generatedCodes.push(data.code);
          invitesRemaining = data.invitesRemaining;
          displayGeneratedCodes();
          document.getElementById('generated-links-section').style.display = 'block';
          document.getElementById('invite-count').textContent = invitesRemaining + (invitesRemaining === 1 ? ' Invite Remaining' : ' Invites Remaining');
          if (generatedCodes.length > 1) {
            document.getElementById('copy-all-container').style.display = 'block';
          }
          if (invitesRemaining <= 0) {
            document.getElementById('no-invites').style.display = 'block';
            document.getElementById('generate-section').style.display = 'none';
          }
        } else if (data.error === 'Signature expired, please sign again') {
          errorEl.textContent = 'Session expired. Please re-verify your wallet.';
          errorEl.classList.add('show');
          walletSignature = '';
          signedMessage = '';
          setTimeout(function() { showView('verify'); }, 2000);
        } else {
          errorEl.textContent = data.error || 'Failed to generate code. Please try again.';
          errorEl.classList.add('show');
        }
      } catch (err) {
        errorEl.textContent = 'Network error. Please try again.';
        errorEl.classList.add('show');
      }

      btn.disabled = false;
      btn.innerHTML = '<svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg> Generate Invite Link';
    }

    function displayGeneratedCodes() {
      var container = document.getElementById('codes-list');
      container.innerHTML = '';
      generatedCodes.forEach(function(code, index) {
        var link = window.location.origin + '/claim/' + code;
        var div = document.createElement('div');
        div.className = 'code-row';
        div.innerHTML = '<div class="code-number">#' + (index + 1) + '</div>' +
          '<div class="code-link">' + link + '</div>' +
          '<button class="btn-copy-small" onclick="copySpecificLink(' + index + ', this)">üìã</button>' +
          '<button class="btn-twitter-small" onclick="shareSpecificLink(' + index + ')"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></button>';
        container.appendChild(div);
      });
    }

    function copySpecificLink(index, btn) {
      var link = window.location.origin + '/claim/' + generatedCodes[index];
      navigator.clipboard.writeText(link);
      btn.textContent = '‚úì';
      btn.classList.add('copied');
      setTimeout(function() { btn.textContent = 'üìã'; btn.classList.remove('copied'); }, 1500);
    }

    function shareSpecificLink(index) {
      var link = window.location.origin + '/claim/' + generatedCodes[index];
      var text = encodeURIComponent("I'm in Youmio Season 1! üöÄ\n\nJoin me and start earning Affinity before it's too late.\n\nClaim your invite:");
      var url = encodeURIComponent(link);
      window.open('https://twitter.com/intent/tweet?text=' + text + '&url=' + url, '_blank');
    }

    function copyAllLinks() {
      var allLinks = generatedCodes.map(function(code) {
        return window.location.origin + '/claim/' + code;
      }).join('\n');
      navigator.clipboard.writeText(allLinks);
      var btn = document.getElementById('copy-all-btn');
      btn.textContent = '‚úì Copied All!';
      setTimeout(function() { btn.textContent = 'üìã Copy All Links'; }, 2000);
    }

    async function submitWallet() {
      var walletInput = document.getElementById('wallet-input');
      var errorMsg = document.getElementById('error-msg');
      var submitBtn = document.getElementById('submit-btn');
      var wallet = walletInput.value.trim();
      errorMsg.classList.remove('show');

      if (!wallet) {
        errorMsg.textContent = 'Please enter your wallet address';
        errorMsg.classList.add('show');
        return;
      }
      if (!/^0x[a-fA-F0-9]{40}$/.test(wallet)) {
        errorMsg.textContent = 'Please enter a valid Ethereum wallet address';
        errorMsg.classList.add('show');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner">‚è≥</span> Submitting...';

      try {
        var response = await fetch('/.netlify/functions/claim-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: currentCode, wallet: wallet })
        });
        var data = await response.json();
        if (data.success) {
          document.getElementById('success-wallet').textContent = wallet;
          showView('success');
        } else {
          errorMsg.textContent = data.error || 'Something went wrong. Please try again.';
          errorMsg.classList.add('show');
        }
      } catch (err) {
        errorMsg.textContent = 'Network error. Please try again.';
        errorMsg.classList.add('show');
      }
      submitBtn.disabled = false;
      submitBtn.textContent = 'Claim Your Access';
    }

    // Event listeners
    document.getElementById('connect-wallet-btn').addEventListener('click', showModal);
    document.getElementById('modal-close').addEventListener('click', hideModal);
    document.getElementById('wallet-modal').addEventListener('click', function(e) {
      if (e.target.id === 'wallet-modal') hideModal();
    });
    document.getElementById('select-metamask').addEventListener('click', function() {
      if (wallets.metamask.provider) connectWithProvider(wallets.metamask.provider);
    });
    document.getElementById('select-coinbase').addEventListener('click', function() {
      if (wallets.coinbase.provider) connectWithProvider(wallets.coinbase.provider);
    });
    document.getElementById('select-phantom').addEventListener('click', function() {
      if (wallets.phantom.provider) connectWithProvider(wallets.phantom.provider);
    });
    document.getElementById('select-rabby').addEventListener('click', function() {
      if (wallets.rabby.provider) connectWithProvider(wallets.rabby.provider);
    });
    document.getElementById('select-injected').addEventListener('click', function() {
      if (wallets.injected.provider) connectWithProvider(wallets.injected.provider);
    });
    document.getElementById('generate-btn').addEventListener('click', generateCode);
    document.getElementById('copy-all-btn').addEventListener('click', copyAllLinks);
    document.getElementById('submit-btn').addEventListener('click', submitWallet);
    document.getElementById('wallet-input').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') submitWallet();
    });

    init();
  </script>
</body>
</html>
